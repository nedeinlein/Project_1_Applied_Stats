---
title: "Group4_EDA"
author: "Puri"
date: "5/23/2021"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(rworldmap)
library(corrplot)
library(tidyr)
library(countrycode)
library(PerformanceAnalytics)
```

```{r}
# Read in dataset
lifeExpec = read.csv("Life Expectancy Data.csv",header = TRUE)
#lifeExpec = read.csv(file.choose())

# Observe dataset in general
dim(lifeExpec)
str(lifeExpec)
head(lifeExpec)

# Add continent column to the dataset
lifeExpec$continent <- countrycode(sourcevar = lifeExpec$Country,
                                   origin = "country.name",
                                   destination = "continent")

# Edit 3 country names
lifeExpec$CountrytoMatch <- as.character(lifeExpec$Country)
lifeExpec$CountrytoMatch[lifeExpec$CountrytoMatch == "CÃ´te d'Ivoire"] <- "Cote d'Ivoire"
lifeExpec$CountrytoMatch[lifeExpec$CountrytoMatch == "Cabo Verde"] <- "Cape Verde"
lifeExpec$CountrytoMatch[lifeExpec$CountrytoMatch == "Czechia"] <- "Czech Republic"

# Create summary table
summary(lifeExpec)

```

# Check and clean up data record for each country
```{r}
unique(lifeExpec$Country) # There are 193 countries in total
unique(lifeExpec$Year) # 16 years of data collection from 2000 to 2015

# There are 10 countries that do not have 16 years of data.  They all have only 2013 data record
lifeExpec %>% group_by(Country) %>% 
  filter(n() != 16)

# Excluded countries with < 16 years of data collection from the dataset
lifeExpec <- lifeExpec %>% 
  group_by(Country) %>% 
  filter(n() == 16)

# Check if there is any country with duplicated year records
lifeExpec %>% group_by(Country, Year) %>% 
  filter(n() > 1) %>% 
  summarize(n=n()) # There is none

# Quick boxplot to see if any country have years of data collection differ from 2000 to 2015. --There is none.
#lifeExpec %>% ggplot(aes(x=Country, y=Year)) + 
#  geom_boxplot() +
#  coord_flip()

# At this point, all 193 - 10 = 183 countries have all 16 years of data record from 2000 to 2015.  Total in 2,928 (183*16) rows.
# Create summary table
summary(lifeExpec)
```

# Address the missing values
```{r}
# Check for missing value in each column
missing.values_summary <- lifeExpec %>%
  gather(key = "key", value = "val") %>%
  mutate(is.missing = is.na(val)) %>%
  group_by(key, is.missing) %>%
  summarise(num.missing = n()) %>%
  filter(is.missing==T) %>%
  select(-is.missing) %>%
  arrange(desc(num.missing))

missing.values_summary

# Missing values % in each column
missing.values <- lifeExpec %>%
  gather(key = "key", value = "val") %>%
  mutate(isna = is.na(val)) %>%
  group_by(key) %>%
  mutate(total = n()) %>%
  group_by(key, total, isna) %>%
  summarise(num.isna = n()) %>%
  mutate(pct = num.isna / total * 100)

levels <- (missing.values %>% filter(isna == T) %>%
             arrange(desc(pct)))$key

percentage.plot <- missing.values %>%
  ggplot() +
  geom_bar(aes(x = reorder(key, desc(pct)),
               y = pct, fill=isna), 
           stat = 'identity', alpha=0.8) +
  scale_x_discrete(limits = levels) +
  scale_fill_manual(name = "", 
                    values = c('steelblue', 'tomato3'), 
                    labels = c("Present", "Missing")) +
  coord_flip() +
  labs(title = "Percentage of missing values", 
       x = 'Variable', y = "% of missing values")

percentage.plot

# Missing value in each observation
missing_col <- subset(lifeExpec, select = c(levels))
vis_miss(missing_col, sort_miss=TRUE)

# We will keep all data for now.  Will decide on method to treat missing data later after we figure it out about the variables that we would like to include in the model
# In my opinion, deleting all missing value will cause too much information lost


# Missing values by country
lifeExpec %>% 
  group_by(Country) %>% 
  summarise_all(~sum(is.na(.))) %>% 
  transmute(Country, sumNA = rowSums(.[-1]))

```

###### Life expectancy correlation coefficient for numerical variables
```{r}
# Correlation coefficient for numerical columns
num_col <- subset(lifeExpec, select = -c(Year, Country, CountrytoMatch, Status, continent))

M <- cor(num_col, use = "complete.obs")
corrplot(M, use="complete.obs")

chart.Correlation(num_col, histogram=TRUE, pch=19)

num_col_highCorr <- subset(num_col, select = -c(infant.deaths, Hepatitis.B, Measles, under.five.deaths, Total.expenditure, Population, thinness..1.19.years, thinness.5.9.years))

chart.Correlation(num_col_highCorr, histogram=TRUE, pch=19)

pairs(num_col_highCorr)
```

```{r}

# Scatter plot life expectancy vs. adult mortality color code by countrys' status.
lifeExpec %>% ggplot(aes(x=Life.expectancy, y=Adult.Mortality, shape=Status, color=Status)) +
  geom_jitter()

lifeExpec %>% ggplot(aes(x=Life.expectancy, y=Schooling, shape=Status, color=Status)) +
  geom_jitter()

lifeExpec %>% ggplot(aes(x=Life.expectancy, y=Income.composition.of.resources, shape=Status, color=Status)) +
  geom_jitter()

lifeExpec %>% ggplot(aes(x=Life.expectancy, y=percentage.expenditure, shape=Status, color=Status)) +
  geom_jitter()

par("mfcol"=c(3, 4))
hist(lifeExpec$Life.expectancy, col="blue")
hist(lifeExpec$Adult.Mortality, col="green")
hist(lifeExpec$infant.deaths, col="red") 
hist(lifeExpec$Alcohol, col="blue")
hist(lifeExpec$percentage.expenditure, col="green")
hist(lifeExpec$under.five.deaths, col="red") 
hist(lifeExpec$Total.expenditure, col="green")
hist(lifeExpec$GDP, col="green")
hist(lifeExpec$Population, col="green")
hist(lifeExpec$Income.composition.of.resources, col="green")
hist(lifeExpec$Schooling, col="green")
par("mfcol"=c(1, 1))

par("mfcol"=c(2, 4))
hist(lifeExpec$BMI, col="green")
hist(lifeExpec$Hepatitis.B, col="red")
hist(lifeExpec$Measles, col="blue")
hist(lifeExpec$Polio, col="blue")
hist(lifeExpec$Diphtheria, col="red") 
hist(lifeExpec$HIV.AIDS, col="blue")
hist(lifeExpec$thinness..1.19.years, col="red")
hist(lifeExpec$thinness..1.19.years, col="blue")
par("mfcol"=c(1, 1))
```

```{r Transformation of GDP, Alcohol, BMI}
lifeExpec %>% ggplot(aes(x=BMI, y=Life.expectancy)) + geom_point() + geom_smooth(method="loess") +geom_jitter()

summary(lifeExpec$BMI)
#THe lowest BMI ever recorded is 7.5.  Mean BMI of 12 is the lower limit for human survival.
lifeExpec %>% filter(BMI<12) %>% select(BMI) %>% arrange(BMI)
BMI_clean <- lifeExpec %>% filter(BMI>=12) %>% select(Life.expectancy, BMI) %>% arrange(BMI)
dim(BMI_clean)

BMI_clean %>% ggplot(aes(x=log(BMI), y=Life.expectancy)) + geom_point() + geom_smooth(method="lm") +geom_jitter()

attach(BMI_clean)
par(mfrow=c(1,3))
plot(log(BMI), Life.expectancy, xlab="BMI", ylab="Life Expectancy")
BMI.model <-lm(Life.expectancy~log(BMI))
plot(BMI.model$fitted.values,BMI.model$residuals, xlab="Fitted Values", ylab="Residuals")
plot(log(BMI), BMI.model$residuals, xlab="BMI", ylab="Residuals")

par(mfrow=c(2,2))
plot(BMI.model)

cor(log(BMI),Life.expectancy)
#BMI Change from .57 to .72

summary(lifeExpec$Alcohol)
#193 NAs
Alcohol_clean <- lifeExpec %>% filter(!is.na(Alcohol)) %>% arrange(Alcohol)
summary(Alcohol_clean$Alcohol)
attach(Alcohol_clean)
Alcohol.model <-lm(log(Life.expectancy)~Alcohol)
par(mfrow=c(1,2))
plot(Alcohol.model$fitted.values,Alcohol.model$residuals, xlab="Fitted Values", ylab="Residuals")
plot(Alcohol, Alcohol.model$residuals, xlab="Alcohol Cons.", ylab="Residuals")

# Alcohol has a nonconstant variance, when both before and after log transformed
# Transforming life expectancy does not help the varaince either.
# Remove Alcohol as a good candidate.

summary(lifeExpec$GDP)
# 443 NAs
GDP_clean <- lifeExpec %>% filter(!is.na(GDP)) %>% arrange(GDP)
summary(GDP_clean$GDP)

attach(GDP_clean)
GDP.model <- lm(Life.expectancy~log(GDP))
par(mfrow=c(1,2))
plot(GDP.model$fitted.values,GDP.model$residuals, xlab="Fitted Values", ylab="Residuals")
plot(log(GDP), GDP.model$residuals, xlab="GDP.", ylab="Residuals")

cor(log(GDP), Life.expectancy)
#GDP chang from .46 to .598

```


```{r Life expectancy trends in categorical variables}
# Boxplot of life expectancy vs. year shows that both mean and median of life expectancy is increasing every year since average (mean) 66.75 in 2000 to average (mean) 71.62 in 2015
Life.expectancy_means <- aggregate(Life.expectancy ~ Year, lifeExpec, mean)

lifeExpec %>% ggplot(aes(x=Year, y=Life.expectancy, group=Year)) + 
  geom_boxplot() + 
  stat_summary(fun=mean, colour="darkred", geom="point", 
               shape=18, size=3, show.legend=FALSE) + 
  geom_text(data=Life.expectancy_means, aes(label = format(round(Life.expectancy, 2), nsmall = 2), y = Life.expectancy - 2.5, col = "darkred")) +
  theme(legend.position = "none") +
  coord_flip()


# Boxplot of life expectancy vs. continent also shows life expectancy increasing trend
lifeExpec %>% ggplot(aes(x=Year, y=Life.expectancy, group=Year)) + 
  geom_boxplot(aes(fill=continent)) +
  facet_grid(continent ~ .)


# Wold map displays life expectancy in general (median value from 2000 - 2015) for each country.  Africa has the lowest life expectancy, follows by Asia.

medianExpec <- aggregate(lifeExpec[, 4], list(lifeExpec$CountrytoMatch), median)
names(medianExpec)[names(medianExpec)=="Group.1"] <- "Country"

countryMap <- joinCountryData2Map(lifeExpec, joinCode = "NAME", nameJoinColumn = "Country")

map <- joinCountryData2Map(
       medianExpec,
       joinCode       = "NAME",
       nameJoinColumn = "Country",
       verbose = TRUE
     )

mapCountryData(map,
               mapTitle = "Median Life Expectancy (2000 - 2015)",
               nameColumnToPlot = "Life.expectancy",
               catMethod = "fixedWidth"
)

# Boxplot life expectancy vs. continent also shows the same trend
lifeExpec %>% ggplot(aes(x=continent, y=Life.expectancy)) + 
  geom_boxplot(aes(fill=continent))

# Scatter plot life expectancy vs. adult martality color code by countrys' status.
lifeExpec %>% ggplot(aes(x=Life.expectancy, y=Adult.Mortality, shape=Status, color=Status)) +
  geom_jitter()

```


```{r Try to fit Linear Regression Model}
# Only consider numerical variables
model_num <- lm(Life.expectancy ~ Adult.Mortality+Alcohol+percentage.expenditure+BMI+Polio+Diphtheria+HIV.AIDS+GDP+Income.composition.of.resources+Schooling, data = lifeExpec)
summary(model_num)

model_num <- lm(Life.expectancy ~ Adult.Mortality+percentage.expenditure+BMI+Polio+Diphtheria+HIV.AIDS+Income.composition.of.resources+Schooling, data = lifeExpec)
summary(model_num)
```

```{r Transformation Diptheria, HIV, and Polio, echo = false}
attach(lifeExpec)
lifeExpec %>% ggplot(aes(x=Diphtheria, y=Life.expectancy)) + geom_point() + geom_smooth(method="loess") + geom_jitter()
oglm <- lm(Life.expectancy~Diphtheria, data = lifeExpec)
summary(oglm)

str(lifeExpec$Diphtheria)
summary(lifeExpec$Diphtheria)

# With diphtheria we are looking at vaccination rates. Anything below 25% would not be enough to impact a significant portion of the population. Thus these were removed.
DIP_clean <- lifeExpec %>% filter(Diphtheria>=25) %>% select(Life.expectancy, Diphtheria)
dim(DIP_clean)

DIP_clean %>% ggplot(aes(x=Diphtheria, y=Life.expectancy)) + geom_point() + geom_smooth(method="lm") +geom_jitter()

attach(DIP_clean)
DIPlm <- lm(Life.expectancy~Diphtheria, data = DIP_clean)
par(mfrow=c(2,2))
plot(DIPlm)
summary(DIPlm)

#Tried additional transformations but none seemed to improve statistics beyond what we see in final model,
#adj R-squared changed from .22 to .38

# HIV deaths per 1000 in under 5 range starting correlation
HIV <- lifeExpec %>% filter(!is.na(HIV.AIDS))
summary(HIV$HIV.AIDS)
HIV %>% ggplot(aes(x=HIV.AIDS, y = Life.expectancy)) +geom_point() + geom_smooth(method = "lm") + geom_jitter()
HIV %>% ggplot(aes(x=log(HIV.AIDS), y = log(Life.expectancy))) +geom_point() + geom_smooth(method = "lm") + geom_jitter()
HIVoglm <- lm(Life.expectancy~HIV.AIDS, data = lifeExpec)
summary(HIVoglm)

attach(HIV)
HIVlm <-lm(log(Life.expectancy)~log(HIV.AIDS))
plot(HIVlm)
summary(HIVlm)

#transformation of both x and y variables allows residual tables to look best.
# Adj R-squared looks much better going from .31 to .68


#Polio
Polio1 <- lifeExpec %>% filter(!is.na(Polio))
summary(Polio$Polio)
Polio1 %>% ggplot(aes(x=Polio, y = Life.expectancy)) +geom_point() + geom_smooth(method = "lm") + geom_jitter()

#similar to Diphtheria vaccination rates nothing below 25 should have a reasonable effect on total population.
Polio_clean <- Polio1 %>% filter(Polio >= 25)

Polio_clean %>% ggplot(aes(x=Polio, y = Life.expectancy)) +geom_point() + geom_smooth(method = "lm") + geom_jitter()
poliooglm <- lm(Life.expectancy~Polio, data = lifeExpec)
summary(poliooglm)

attach(Polio_clean)
poliolm <-lm(Life.expectancy~Polio, data = Polio_clean)
plot(poliolm)
summary(poliolm)

#No drastic improvements adj R-Squared went from .22 to .38

```